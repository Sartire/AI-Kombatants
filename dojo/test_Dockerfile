# syntax=docker/dockerfile:1

# Build stage - includes build tools and dependencies
FROM ubuntu:jammy AS builder

ENV DEBIAN_FRONTEND=noninteractive

# Install build dependencies in a single layer
RUN apt-get update && apt-get install -y --no-install-recommends \
    software-properties-common \
    git \
    gcc \
    g++ \
    && add-apt-repository ppa:deadsnakes/ppa \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
        python3.12 \
        python3.12-venv \
        python3.12-dev \
    && rm -rf /var/lib/apt/lists/*

# Create and activate virtual environment
RUN python3.12 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Ensure pip is up to date
RUN python3.12 -m pip install --no-cache-dir --upgrade pip setuptools wheel

# Install Python packages
COPY --from=project ./requirements.txt /tmp/requirements.txt
RUN pip install --no-cache-dir -r /tmp/requirements.txt

# Build and install stable-retro (shallow clone to save space)
RUN git clone --depth 1 https://github.com/Sartire/stable-retro.git /tmp/stable-retro \
    && pip install --no-cache-dir -e /tmp/stable-retro \
    && rm -rf /tmp/stable-retro/.git

# Install Ray with RLlib
RUN pip install --no-cache-dir "ray[rllib]"

# Runtime stage - minimal dependencies only
FROM ubuntu:jammy

ENV DEBIAN_FRONTEND=noninteractive

# Install only runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    software-properties-common \
    && add-apt-repository ppa:ubuntuhandbook1/ffmpeg8 \
    && add-apt-repository ppa:deadsnakes/ppa \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
        # Virtual desktop
        xvfb \
        x11vnc \
        fluxbox \
        # OpenGL runtime libraries (not dev packages)
        libgl1-mesa-glx \
        libglu1-mesa \
        freeglut3 \
        # FFmpeg
        ffmpeg \
        # Python runtime
        python3.12 \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Set Python 3.12 as default
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1 \
    && update-alternatives --install /usr/bin/python python /usr/bin/python3.12 1

# Copy Python virtual environment from builder stage
COPY --from=builder /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Copy and import ROM
COPY --from=project ./rom /usr/src/rom
RUN python3.12 -m retro.import /usr/src/rom \
    && rm -rf /usr/src/rom

# Set working directory
WORKDIR /usr/src/code

# Expose needed ports
EXPOSE 8889 6006 5900

